name: Generate & Deploy Pages

on:
  schedule:
    # Run daily at 10 PM (off-peak)
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of cities to process'
        required: false
        default: '5000'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Create .env from secrets
        run: |
          echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> .env
          echo "CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}" >> .env
          echo "OPENWEATHER_API_KEY=${{ secrets.OPENWEATHER_API_KEY }}" >> .env
          echo "EVENTBRITE_API_KEY=${{ secrets.EVENTBRITE_API_KEY }}" >> .env
          echo "DEEPSEEK_API_URL=https://api.deepseek.com/v1" >> .env
          echo "CLAUDE_MODEL=claude-opus-4-1-20250805" >> .env

      - name: Generate pages
        run: |
          node scripts/generate-pages.js \
            --batch-size ${{ github.event.inputs.batch_size || 5000 }} \
            --services all \
            --output ./output

      - name: Generate sitemap
        run: node scripts/generate-sitemap.js

      - name: Validate HTML
        run: node scripts/validate-html.js

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload to S3
        run: |
          aws s3 sync ./output s3://citysyncai-pages \
            --cache-control "max-age=31536000,public" \
            --exclude "*" \
            --include "*.html"

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"

      - name: Submit sitemap to GSC
        run: |
          node scripts/submit-sitemap-to-gsc.js \
            --service-account-key '${{ secrets.GSC_SERVICE_ACCOUNT_KEY }}'

      - name: Generate report
        if: always()
        run: node scripts/generate-report.js --output ./reports/latest.json

      - name: Upload report to artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: generation-report
          path: ./reports/latest.json

      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "ðŸš€ CitySync Generation Complete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Status: ${{ job.status }}\nBatch: ${{ github.event.inputs.batch_size || 5000 }}\nTimestamp: ${{ github.event.head_commit.timestamp }}"
                  }
                }
              ]
            }

      - name: Send email report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "CitySync Generation Report - ${{ github.event.schedule }}"
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: citysync@combrokers.com
          body: |
            Generation Complete
            Batch Size: ${{ github.event.inputs.batch_size || 5000 }}
            Status: ${{ job.status }}
            Timestamp: ${{ github.event.head_commit.timestamp }}
            
            See attached report for details.
          attachments: ./reports/latest.json

      - name: Upload report to artifact
        uses: actions/upload-artifact@v3
        with:
          name: generation-report-${{ github.run_number }}
          path: ./reports/latest.json
          retention-days: 30
